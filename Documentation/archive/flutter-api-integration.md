# Flutter API Integration Guide

## Overview

This document provides comprehensive details for integrating the Flutter mobile app with the existing AI Quiz Maker NestJS API. All endpoints are RESTful and return JSON responses with consistent error handling.

## Base Configuration

### API Endpoints
- **Development**: `http://localhost:8000/api`
- **Production**: `https://yourdomain.com/api`

### Common Response Format
```json
{
  "success": boolean,
  "message": string,
  "data": object | array,
  "error": string (optional)
}
```

## Authentication
Currently, the API does not require authentication, but the Flutter app should be prepared to add authorization headers when needed.

## Core API Endpoints

### 1. File Upload
**Endpoint**: `POST /upload`
**Purpose**: Upload PDF files for quiz generation
**Content-Type**: `multipart/form-data`

#### Request
```dart
FormData formData = FormData.fromMap({
  'file': await MultipartFile.fromFile(
    pdfFile.path,
    filename: pdfFile.name,
  ),
});
```

#### Response
```json
{
  "success": true,
  "message": "PDF file uploaded successfully",
  "file": {
    "filename": "file-1234567890-123456789.pdf",
    "originalname": "document.pdf",
    "mimetype": "application/pdf",
    "size": 1048576,
    "path": "./uploads/file-1234567890-123456789.pdf"
  }
}
```

#### Error Responses
- File too large: `MAX_FILE_SIZE_EXCEEDED`
- Invalid file type: `INVALID_FILE_TYPE`
- No file provided: `FILE_NOT_PROVIDED`

### 2. Quiz Generation (Streaming)
**Endpoint**: `GET /generate-quiz-stream/:filename`
**Purpose**: Generate quiz with real-time progress updates
**Method**: Server-Sent Events (SSE)

#### Request
```dart
// URL with query parameters
String url = '/generate-quiz-stream/$filename?language=en&questionsPerPage=2&includeExplanations=true';
```

#### Query Parameters
- `language`: Language code (default: 'en')
- `questionsPerPage`: Number of questions per page (default: 2)
- `includeExplanations`: Include answer explanations (default: true)
- `difficulty`: Quiz difficulty level (optional)

#### Streaming Events
```dart
// Event types received during streaming
enum QuizGenerationEvent {
  'quiz-started',
  'processing-pdf',
  'extracting-text',
  'generating-metadata',
  'metadata-generated',
  'generating-questions',
  'question-generated',
  'quiz-completed',
  'error'
}
```

#### Sample Stream Events
```json
// Event: quiz-started
{
  "event": "quiz-started",
  "data": {
    "filename": "document.pdf",
    "totalPages": 10,
    "language": "en"
  }
}

// Event: question-generated
{
  "event": "question-generated",
  "data": {
    "questionNumber": 1,
    "totalQuestions": 20,
    "question": {
      "id": "q1",
      "text": "What is the main topic?",
      "options": ["A", "B", "C", "D"],
      "correctAnswer": 0,
      "explanation": "The answer is A because..."
    }
  }
}

// Event: quiz-completed
{
  "event": "quiz-completed",
  "data": {
    "quizId": "quiz-12345",
    "magicLink": "abc123def456",
    "totalQuestions": 20,
    "title": "Generated Quiz Title",
    "description": "Quiz description generated by AI"
  }
}
```

### 3. Quiz Retrieval
**Endpoint**: `GET /quiz/:quizId`
**Purpose**: Get complete quiz by ID

#### Response
```json
{
  "success": true,
  "quiz": {
    "id": "quiz-12345",
    "title": "AI Generated Quiz",
    "description": "Quiz about the uploaded document",
    "language": "en",
    "magicLink": "abc123def456",
    "questions": [
      {
        "id": "q1",
        "text": "Question text",
        "options": ["Option A", "Option B", "Option C", "Option D"],
        "correctAnswer": 0,
        "explanation": "Explanation text"
      }
    ],
    "createdAt": "2024-12-19T10:00:00Z",
    "sourceFile": "document.pdf"
  }
}
```

### 4. Quiz by Magic Link
**Endpoint**: `GET /quiz/magic/:magicLink`
**Purpose**: Get quiz using shareable magic link

#### Response
Same as quiz retrieval, but accessed via magic link instead of quiz ID.

### 5. List Quizzes
**Endpoint**: `GET /quizzes`
**Purpose**: Get all generated quizzes

#### Response
```json
{
  "success": true,
  "quizzes": [
    {
      "id": "quiz-12345",
      "title": "Quiz Title",
      "description": "Quiz description",
      "createdAt": "2024-12-19T10:00:00Z",
      "questionCount": 20,
      "language": "en"
    }
  ],
  "total": 1,
  "count": 1
}
```

### 6. Configuration
**Endpoint**: `GET /config`
**Purpose**: Get API configuration and limits

#### Response
```json
{
  "success": true,
  "config": {
    "maxPdfSize": 104857600,
    "maxPdfSizeMB": 100,
    "maxPagesPerPdf": 200,
    "defaultQuestionsPerPage": 2,
    "supportedLanguages": [
      { "code": "en", "name": "English" },
      { "code": "es", "name": "Spanish" }
    ]
  }
}
```

### 7. Supported Languages
**Endpoint**: `GET /languages`
**Purpose**: Get list of supported languages

#### Response
```json
{
  "success": true,
  "languages": [
    { "code": "en", "name": "English" },
    { "code": "es", "name": "Spanish" },
    { "code": "fr", "name": "French" }
  ],
  "count": 16
}
```

### 8. File Management
**Endpoint**: `GET /files`
**Purpose**: List uploaded files

#### Response
```json
{
  "success": true,
  "files": [
    {
      "filename": "file-123.pdf",
      "originalName": "document.pdf",
      "size": 1048576,
      "uploadDate": "2024-12-19T10:00:00Z",
      "hasQuiz": true
    }
  ],
  "total": 1
}
```

### 9. File Download
**Endpoint**: `GET /files/:filename`
**Purpose**: Download uploaded file
**Response**: Binary PDF data

### 10. File Info
**Endpoint**: `GET /files/:filename/info`
**Purpose**: Get file metadata

#### Response
```json
{
  "success": true,
  "file": {
    "filename": "file-123.pdf",
    "originalName": "document.pdf",
    "size": 1048576,
    "uploadDate": "2024-12-19T10:00:00Z",
    "hasQuiz": true,
    "quizId": "quiz-12345"
  }
}
```

## Flutter Integration Implementation

### 1. API Service Setup
```dart
class ApiService {
  late final Dio _dio;
  static const String baseUrl = 'http://localhost:8000/api';
  
  ApiService() {
    _dio = Dio(BaseOptions(
      baseUrl: baseUrl,
      connectTimeout: const Duration(seconds: 30),
      receiveTimeout: const Duration(seconds: 30),
    ));
    
    _setupInterceptors();
  }
  
  void _setupInterceptors() {
    _dio.interceptors.add(LogInterceptor(
      requestBody: true,
      responseBody: true,
      logPrint: (obj) => print(obj),
    ));
    
    _dio.interceptors.add(
      InterceptorsWrapper(
        onError: (error, handler) {
          // Handle common errors
          _handleApiError(error);
          handler.next(error);
        },
      ),
    );
  }
}
```

### 2. File Upload Implementation
```dart
Future<UploadResponse> uploadPdf(File pdfFile) async {
  try {
    FormData formData = FormData.fromMap({
      'file': await MultipartFile.fromFile(
        pdfFile.path,
        filename: path.basename(pdfFile.path),
      ),
    });
    
    final response = await _dio.post('/upload', data: formData);
    return UploadResponse.fromJson(response.data);
  } catch (e) {
    throw ApiException('Upload failed: ${e.toString()}');
  }
}
```

### 3. Streaming Quiz Generation
```dart
Stream<QuizGenerationEvent> generateQuizStream(
  String filename, {
  String language = 'en',
  int questionsPerPage = 2,
  bool includeExplanations = true,
}) async* {
  final url = '$baseUrl/generate-quiz-stream/$filename'
      '?language=$language'
      '&questionsPerPage=$questionsPerPage'
      '&includeExplanations=$includeExplanations';
  
  final request = http.Request('GET', Uri.parse(url));
  final response = await request.send();
  
  await for (String line in response.stream
      .transform(utf8.decoder)
      .transform(const LineSplitter())) {
    
    if (line.startsWith('data: ')) {
      final jsonStr = line.substring(6);
      if (jsonStr.isNotEmpty && jsonStr != '[DONE]') {
        final event = QuizGenerationEvent.fromJson(
          json.decode(jsonStr)
        );
        yield event;
      }
    }
  }
}
```

### 4. Error Handling
```dart
class ApiException implements Exception {
  final String message;
  final String? errorCode;
  final int? statusCode;
  
  ApiException(this.message, {this.errorCode, this.statusCode});
  
  @override
  String toString() => 'ApiException: $message';
}

void _handleApiError(DioException error) {
  switch (error.type) {
    case DioExceptionType.connectionTimeout:
      throw ApiException('Connection timeout');
    case DioExceptionType.receiveTimeout:
      throw ApiException('Response timeout');
    case DioExceptionType.badResponse:
      final statusCode = error.response?.statusCode;
      final message = error.response?.data['message'] ?? 'Unknown error';
      throw ApiException(message, statusCode: statusCode);
    default:
      throw ApiException('Network error: ${error.message}');
  }
}
```

## State Management Integration

### 1. Quiz Provider
```dart
@riverpod
class QuizNotifier extends _$QuizNotifier {
  @override
  AsyncValue<Quiz?> build() => const AsyncValue.data(null);
  
  Future<void> generateQuiz(String filename) async {
    state = const AsyncValue.loading();
    
    try {
      Quiz? generatedQuiz;
      
      await for (final event in ref.read(apiServiceProvider)
          .generateQuizStream(filename)) {
        
        if (event.type == 'quiz-completed') {
          generatedQuiz = Quiz.fromJson(event.data);
          break;
        }
        
        // Emit progress updates
        ref.read(quizGenerationProgressProvider.notifier)
            .updateProgress(event);
      }
      
      state = AsyncValue.data(generatedQuiz);
    } catch (error) {
      state = AsyncValue.error(error, StackTrace.current);
    }
  }
}
```

## Testing Strategy

### 1. Mock API Responses
```dart
class MockApiService extends ApiService {
  @override
  Future<UploadResponse> uploadPdf(File pdfFile) async {
    await Future.delayed(const Duration(seconds: 2));
    return UploadResponse(
      success: true,
      filename: 'mock-file.pdf',
      originalName: pdfFile.path.split('/').last,
    );
  }
  
  @override
  Stream<QuizGenerationEvent> generateQuizStream(String filename) {
    // Return mock streaming events
  }
}
```

### 2. Integration Tests
```dart
void main() {
  group('API Integration Tests', () {
    late ApiService apiService;
    
    setUp(() {
      apiService = ApiService();
    });
    
    test('should upload PDF successfully', () async {
      final mockPdf = File('test/fixtures/sample.pdf');
      final response = await apiService.uploadPdf(mockPdf);
      
      expect(response.success, isTrue);
      expect(response.filename, isNotEmpty);
    });
  });
}
```

## Performance Considerations

### 1. Caching Strategy
- Cache configuration and language data
- Store completed quizzes locally
- Implement proper cache invalidation

### 2. Network Optimization
- Request deduplication
- Retry logic for failed requests
- Connection pooling for efficiency

### 3. Memory Management
- Stream processing for large responses
- Dispose of resources properly
- Limit concurrent requests

## Security Best Practices

### 1. HTTPS Only
```dart
BaseOptions(
  baseUrl: 'https://yourdomain.com/api',
  validateStatus: (status) => status! < 500,
)
```

### 2. Request Validation
- Validate file types before upload
- Check file size limits
- Sanitize user inputs

### 3. Error Information
- Don't expose sensitive error details
- Log errors securely
- Provide user-friendly error messages 