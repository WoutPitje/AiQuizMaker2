# Terraform Google Cloud Project Creation

This document explains how AiQuizMaker's Terraform configuration can automatically create new Google Cloud projects, eliminating permission issues and streamlining deployment.

## üéØ Overview

Instead of requiring users to manually create Google Cloud projects or have access to existing ones, our Terraform configuration can now:

- Create brand new Google Cloud projects automatically
- Generate unique project IDs to avoid conflicts
- Set up all required APIs and permissions
- Eliminate permission denied errors

## üöÄ Quick Start

### Prerequisites

1. **Google Cloud Account**: You need a Google Cloud account with billing enabled
2. **Organization Access**: You need access to a Google Cloud Organization or Folder
3. **Required Permissions**: You need these IAM roles at the organization/folder level:
   - `roles/resourcemanager.projectCreator`
   - `roles/billing.user`
   - `roles/iam.serviceAccountAdmin`

### Automatic Setup

1. **Run the setup script:**
   ```bash
   cd terraform
   ./setup.sh
   ```

2. **The script will:**
   - Generate a unique project ID (e.g., `aiquizmaker-1734567890`)
   - Create `terraform.tfvars` with the new project ID
   - Prompt you to fill in required values

3. **Edit `terraform.tfvars`:**
   ```bash
   nano terraform.tfvars
   ```

   Fill in these required values:
   ```hcl
   # Generated automatically - don't change
   project_id = "aiquizmaker-1734567890"
   create_project = true
   
   # You need to provide these
   billing_account = "012345-6789AB-CDEF01"  # Your billing account ID
   org_id = "123456789012"                   # Your organization ID
   openai_api_key = "sk-your-key-here"       # Your OpenAI API key
   ```

4. **Deploy:**
   ```bash
   terraform apply
   ```

## üîß Configuration Options

### Creating a New Project (Default)

```hcl
create_project = true
project_id = "aiquizmaker-1734567890"  # Unique ID generated by setup script
project_name = "AiQuizMaker Dev"
```

This will:
- Create a new Google Cloud project
- Enable all required APIs
- Set up service accounts and IAM
- Configure billing

### Using an Existing Project

```hcl
create_project = false
project_id = "my-existing-project"
project_name = "My Existing Project"
```

This will:
- Use the existing project
- Enable any missing APIs
- Create service accounts if they don't exist
- Set up required IAM permissions

## üèóÔ∏è What Gets Created

When `create_project = true`, Terraform creates:

### 1. Google Cloud Project
```hcl
resource "google_project" "project" {
  name            = var.project_name
  project_id      = var.project_id
  billing_account = var.billing_account
  org_id          = var.org_id
  labels          = var.labels
}
```

### 2. Required APIs
- Cloud Resource Manager API
- IAM API
- Cloud Run API
- Cloud Build API
- Container Registry API
- Cloud Storage API
- Secret Manager API
- Cloud Monitoring API
- Cloud Logging API
- Cloud Trace API
- Error Reporting API

### 3. Service Accounts
- Cloud Run service account with minimal required permissions

### 4. Secret Management
- OpenAI API key stored securely in Secret Manager

## üìã Required Information

To create a new project, you need:

### Billing Account ID
Find your billing account ID:
```bash
gcloud billing accounts list
```

### Organization ID
Find your organization ID:
```bash
gcloud organizations list
```

Or use a Folder ID instead:
```bash
gcloud resource-manager folders list --organization=ORG_ID
```

### OpenAI API Key
Get your API key from [OpenAI Platform](https://platform.openai.com/account/api-keys)

## üîç Troubleshooting

### Permission Denied During Project Creation

If you get permission errors when creating the project:

1. **Check your IAM roles:**
   ```bash
   gcloud projects get-iam-policy PROJECT_ID --flatten="bindings[].members" --format="table(bindings.role)" --filter="bindings.members:your-email@domain.com"
   ```

2. **Verify organization access:**
   ```bash
   gcloud organizations get-iam-policy ORG_ID --flatten="bindings[].members" --format="table(bindings.role)" --filter="bindings.members:your-email@domain.com"
   ```

3. **Required roles for project creation:**
   - `roles/resourcemanager.projectCreator`
   - `roles/billing.user`

### Project ID Already Exists

If the generated project ID already exists:

1. **Run setup script again** to generate a new unique ID:
   ```bash
   rm terraform.tfvars
   ./setup.sh
   ```

2. **Or manually edit** the project ID in `terraform.tfvars`:
   ```hcl
   project_id = "aiquizmaker-$(date +%s)"
   ```

### Billing Account Issues

If billing setup fails:

1. **Verify billing account is active:**
   ```bash
   gcloud billing accounts describe BILLING_ACCOUNT_ID
   ```

2. **Check billing permissions:**
   ```bash
   gcloud billing accounts get-iam-policy BILLING_ACCOUNT_ID
   ```

## üí° Best Practices

### Development Environment
```hcl
project_id = "aiquizmaker-dev-${timestamp}"
environment = "dev"
create_project = true
```

### Production Environment
```hcl
project_id = "aiquizmaker-prod"
environment = "prod"
create_project = true  # Or false if using existing project
```

### Project Naming
- Use consistent naming: `aiquizmaker-{env}-{timestamp}`
- Include environment: `dev`, `staging`, `prod`
- Add timestamp for uniqueness in development

### Resource Cleanup
To destroy everything including the project:
```bash
terraform destroy
```

‚ö†Ô∏è **Warning**: This will delete the entire project and all data!

## üîó Related Documentation

- [Terraform GCP Deployment Guide](./Terraform-GCP-Deployment.md)
- [Google Cloud Project Creation](https://cloud.google.com/resource-manager/docs/creating-managing-projects)
- [Terraform Google Provider](https://registry.terraform.io/providers/hashicorp/google/latest/docs) 